<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Connection Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            padding: 20px;
        }

        .result-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .result-section:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .result-section h3 {
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-good { background: var(--success); }
        .status-warning { background: var(--warning); }
        .status-bad { background: var(--danger); }

        .speed-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--dark);
        }

        .metric-label {
            color: var(--gray);
            margin-top: 5px;
            font-size: 0.9em;
        }

        .log-output {
            background: var(--dark);
            color: var(--light);
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .port-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .port-item {
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .port-open {
            border-left: 4px solid var(--success);
            background: linear-gradient(135deg, #f8fff8, #ffffff);
        }

        .port-closed {
            border-left: 4px solid var(--danger);
            background: linear-gradient(135deg, #fff8f8, #ffffff);
        }

        .connection-quality {
            text-align: center;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .quality-score {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .quality-text {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary-card i {
            font-size: 2em;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .firewall-status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .firewall-safe {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .firewall-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .firewall-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .bottleneck-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }

        .bottleneck-item.high {
            border-left-color: var(--danger);
            background: #fdf2f2;
        }

        .bottleneck-item.medium {
            border-left-color: var(--warning);
            background: #fef9f2;
        }

        .bottleneck-item.low {
            border-left-color: var(--success);
            background: #f2f9f2;
        }

        .severity-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .severity-badge.high { background: var(--danger); }
        .severity-badge.medium { background: var(--warning); }
        .severity-badge.low { background: var(--success); }

        .bottleneck-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .suggestion {
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-top: 8px;
            border-left: 3px solid var(--info);
        }

        .latency-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .dns-servers, .domain-response-times {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .dns-server-item, .domain-response {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .domain-response {
            display: flex;
            justify-content: space-between;
        }

        .domain-response.good { border-left: 3px solid var(--success); }
        .domain-response.fair { border-left: 3px solid var(--warning); }
        .domain-response.poor { border-left: 3px solid var(--danger); }
        .domain-response.error { border-left: 3px solid var(--gray); }

        .troubleshooting-section {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .troubleshooting-section ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .troubleshooting-section li {
            margin: 5px 0;
        }

        .diagnostic-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .test-buttons, .diagnostic-buttons {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }

            .header h1 {
                font-size: 2em;
            }

            .tab-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-network-wired"></i> Network Connection Analyzer</h1>
            <p>Comprehensive analysis of your connection path, firewall status, and network performance</p>
        </div>

        <div class="controls">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('basic')">Basic Tests</button>
                <button class="tab-button" onclick="showTab('advanced')">Advanced Diagnostics</button>
                <button class="tab-button" onclick="showTab('troubleshooting')">Troubleshooting</button>
            </div>

            <div id="basic-tab" class="tab-content active">
                <div class="test-buttons">
                    <button class="btn btn-primary" onclick="runTest('all')">
                        <i class="fas fa-rocket"></i> Complete Analysis
                    </button>
                    <button class="btn btn-success" onclick="runTest('speed')">
                        <i class="fas fa-tachometer-alt"></i> Speed Test
                    </button>
                    <button class="btn btn-warning" onclick="runTest('traceroute')">
                        <i class="fas fa-route"></i> Trace Route
                    </button>
                    <button class="btn btn-danger" onclick="runTest('firewall')">
                        <i class="fas fa-shield-alt"></i> Firewall Check
                    </button>
                    <button class="btn btn-info" onclick="runTest('ports')">
                        <i class="fas fa-plug"></i> Port Scan
                    </button>
                </div>
            </div>

            <div id="advanced-tab" class="tab-content">
                <div class="diagnostic-buttons">
                    <button class="btn btn-info" onclick="runAdvancedTest('latency_monitor')">
                        <i class="fas fa-heartbeat"></i> Latency Monitor
                    </button>
                    <button class="btn btn-info" onclick="runAdvancedTest('bandwidth_quality')">
                        <i class="fas fa-tachometer-alt"></i> Bandwidth Quality
                    </button>
                    <button class="btn btn-info" onclick="runAdvancedTest('dns_performance')">
                        <i class="fas fa-globe"></i> DNS Performance
                    </button>
                    <button class="btn btn-warning" onclick="runAdvancedTest('bottleneck')">
                        <i class="fas fa-search"></i> Find Bottlenecks
                    </button>
                    <button class="btn btn-success" onclick="runAdvancedTest('throughput')">
                        <i class="fas fa-chart-line"></i> Throughput Test
                    </button>
                    <button class="btn btn-primary" onclick="runAdvancedTest('complete')">
                        <i class="fas fa-cogs"></i> Complete Diagnostic
                    </button>
                </div>
            </div>

            <div id="troubleshooting-tab" class="tab-content">
                <div class="test-buttons">
                    <button class="btn btn-warning" onclick="runTroubleshooting()">
                        <i class="fas fa-tools"></i> Generate Troubleshooting Guide
                    </button>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Running network diagnostics...</p>
            </div>

            <div id="testResults"></div>
        </div>
    </div>

    <script>
        let currentCharts = [];

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // Clean up existing charts
        function cleanupCharts() {
            currentCharts.forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            currentCharts = [];
        }

        // Basic tests
        async function runTest(testType) {
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('testResults');

            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            cleanupCharts();

            try {
                const response = await fetch('/api/network-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test_type: testType
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayBasicResults(data, testType);

            } catch (error) {
                console.error('Test failed:', error);
                resultsDiv.innerHTML = `
                    <div class="result-section">
                        <h3><i class="fas fa-exclamation-triangle"></i> Test Failed</h3>
                        <p>Error: ${error.message}</p>
                        <p>Please check if the server is running and try again.</p>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Advanced diagnostics
        async function runAdvancedTest(testType) {
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('testResults');

            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            cleanupCharts();

            try {
                const response = await fetch('/api/advanced-diagnostics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test_type: testType
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayAdvancedResults(data, testType);

            } catch (error) {
                console.error('Advanced test failed:', error);
                resultsDiv.innerHTML = `
                    <div class="result-section">
                        <h3><i class="fas fa-exclamation-triangle"></i> Advanced Test Failed</h3>
                        <p>Error: ${error.message}</p>
                        <p>Please check if the server is running and try again.</p>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Troubleshooting
        async function runTroubleshooting() {
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('testResults');

            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            cleanupCharts();

            try {
                const response = await fetch('/api/advanced-diagnostics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test_type: 'complete'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayTroubleshootingGuide(data.troubleshooting_guide);

            } catch (error) {
                console.error('Troubleshooting failed:', error);
                resultsDiv.innerHTML = `
                    <div class="result-section">
                        <h3><i class="fas fa-exclamation-triangle"></i> Troubleshooting Failed</h3>
                        <p>Error: ${error.message}</p>
                        <p>Please check if the server is running and try again.</p>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayBasicResults(data, testType) {
            const resultsDiv = document.getElementById('testResults');
            let html = '';

            // Connection Quality Summary
            if (data.connection_quality) {
                html += `
                    <div class="connection-quality">
                        <div class="quality-score">${data.connection_quality.score}/100</div>
                        <div class="quality-text">${data.connection_quality.quality}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${data.connection_quality.score}%"></div>
                        </div>
                        <p>${data.connection_quality.description}</p>
                    </div>
                `;
            }

            // Test Information
            html += `
                <div class="result-section">
                    <h3><i class="fas fa-info-circle"></i> Test Information</h3>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <i class="fas fa-clock"></i>
                            <p><strong>Test Time</strong></p>
                            <p>${new Date(data.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="summary-card">
                            <i class="fas fa-desktop"></i>
                            <p><strong>Client IP</strong></p>
                            <p>${data.client_ip}</p>
                        </div>
                        <div class="summary-card">
                            <i class="fas fa-server"></i>
                            <p><strong>Server Time</strong></p>
                            <p>${data.server_time}</p>
                        </div>
                    </div>
                </div>
            `;

            // Speed Test Results
            if (data.speed_test) {
                const speedGrade = getSpeedGrade(data.speed_test.download_mbps);

                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-tachometer-alt"></i> Network Speed Test</h3>
                        <div class="speed-metrics">
                            <div class="metric-card">
                                <div class="metric-value">${data.speed_test.download_mbps} Mbps</div>
                                <div class="metric-label">Download Speed</div>
                                <small>${speedGrade.download}</small>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.speed_test.upload_mbps} Mbps</div>
                                <div class="metric-label">Upload Speed</div>
                                <small>${speedGrade.upload}</small>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.speed_test.latency_ms} ms</div>
                                <div class="metric-label">Latency</div>
                                <small>${getLatencyGrade(data.speed_test.latency_ms)}</small>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.speed_test.jitter_ms || 'N/A'} ms</div>
                                <div class="metric-label">Jitter</div>
                                <small>${data.speed_test.quality || 'N/A'}</small>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Ping Test Results
            if (data.ping) {
                const status = data.ping.success ? 'Successful' : 'Failed';
                const statusClass = data.ping.success ? 'status-good' : 'status-bad';
                const packetLossColor = data.ping.packet_loss > 10 ? 'status-bad' :
                                      data.ping.packet_loss > 5 ? 'status-warning' : 'status-good';

                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-satellite-dish"></i> Ping Test</h3>
                        <p>Status: <span class="status-indicator ${statusClass}"></span>${status}</p>
                        <p>Packets Sent: ${data.ping.packets_sent || 'N/A'}</p>
                        <p>Packet Loss: <span class="status-indicator ${packetLossColor}"></span>${data.ping.packet_loss || 0}%</p>
                        <p>Average Latency: ${data.ping.average_latency || 'N/A'} ms</p>
                        <p>Target: ${data.ping.target || '8.8.8.8'}</p>
                        <div class="log-output">${data.ping.output || data.ping.error || 'No output available'}</div>
                    </div>
                `;
            }

            // Traceroute Results
            if (data.traceroute) {
                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-route"></i> Route Tracing</h3>
                        <p>Hops Detected: ${data.traceroute.hops_count || 'N/A'}</p>
                        ${data.traceroute.error ? `<p style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> ${data.traceroute.error}</p>` : ''}
                        <div class="log-output">${data.traceroute.output || 'No output available'}</div>
                    </div>
                `;
            }

            // Port Scan Results
            if (data.port_scan) {
                let portsHtml = '<div class="port-grid">';
                Object.entries(data.port_scan).forEach(([port, info]) => {
                    const status = info.open ? 'Open' : 'Closed';
                    const statusClass = info.open ? 'port-open' : 'port-closed';
                    const statusIcon = info.open ? 'fa-check-circle' : 'fa-times-circle';
                    const statusColor = info.open ? 'var(--success)' : 'var(--danger)';

                    portsHtml += `
                        <div class="port-item ${statusClass}">
                            <i class="fas ${statusIcon}" style="color: ${statusColor}; font-size: 1.5em; margin-bottom: 8px;"></i>
                            <div><strong>Port ${port}</strong></div>
                            <div style="font-size: 0.8em; color: #666;">${info.service}</div>
                            <div style="font-size: 0.7em; margin: 5px 0; color: #888;">${info.description}</div>
                            <div style="font-size: 0.8em; margin-top: 5px; color: ${statusColor}">${status}</div>
                        </div>
                    `;
                });
                portsHtml += '</div>';

                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-plug"></i> Port Status Analysis</h3>
                        ${portsHtml}
                    </div>
                `;
            }

            // Firewall Analysis
            if (data.firewall_analysis) {
                const firewallStatus = data.firewall_analysis.firewall_detected ?
                    'Firewall Detected' : 'No Significant Firewall Restrictions';
                const statusClass = data.firewall_analysis.firewall_detected ?
                    (data.firewall_analysis.firewall_level === 'High' ? 'firewall-danger' : 'firewall-warning') :
                    'firewall-safe';

                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-shield-alt"></i> Firewall Analysis</h3>
                        <div class="${statusClass} firewall-status">
                            ${firewallStatus} - Level: ${data.firewall_analysis.firewall_level}
                        </div>
                        <p><strong>Blocked Ports:</strong> ${data.firewall_analysis.blocked_ports.join(', ') || 'None detected'}</p>
                        <p><strong>Ping Blocked:</strong> ${data.firewall_analysis.ping_blocked ? 'Yes' : 'No'}</p>

                        <h4 style="margin-top: 15px;">Common Ports Status:</h4>
                        <div class="port-grid">
                `;

                // Display common ports status
                Object.entries(data.firewall_analysis.common_ports_status || {}).forEach(([port, isOpen]) => {
                    const service = getServiceName(parseInt(port));
                    html += `
                        <div class="port-item ${isOpen ? 'port-open' : 'port-closed'}">
                            <strong>Port ${port}</strong><br>
                            <small>${service}</small><br>
                            <span style="color: ${isOpen ? 'var(--success)' : 'var(--danger)'}">
                                ${isOpen ? 'Open' : 'Closed'}
                            </span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        function displayAdvancedResults(data, testType) {
            const resultsDiv = document.getElementById('testResults');
            let html = '';

            // Test Information
            html += `
                <div class="result-section">
                    <h3><i class="fas fa-info-circle"></i> Advanced Diagnostics</h3>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <i class="fas fa-clock"></i>
                            <p><strong>Test Time</strong></p>
                            <p>${new Date(data.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="summary-card">
                            <i class="fas fa-desktop"></i>
                            <p><strong>Client IP</strong></p>
                            <p>${data.client_ip}</p>
                        </div>
                        <div class="summary-card">
                            <i class="fas fa-microchip"></i>
                            <p><strong>Test Type</strong></p>
                            <p>${testType.replace('_', ' ').toUpperCase()}</p>
                        </div>
                    </div>
                </div>
            `;

            // Connection Quality
            if (data.connection_quality) {
                html += `
                    <div class="connection-quality">
                        <div class="quality-score">${data.connection_quality.score}/100</div>
                        <div class="quality-text">${data.connection_quality.quality}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${data.connection_quality.score}%"></div>
                        </div>
                        <p>${data.connection_quality.description}</p>
                    </div>
                `;
            }

            // Latency Monitor
            if (data.latency_monitor && data.latency_monitor.latencies && data.latency_monitor.latencies.length > 0) {
                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-heartbeat"></i> Latency Monitoring</h3>
                        <div class="latency-stats">
                            <div class="stat-item">
                                <span class="stat-label">Average Latency:</span>
                                <span class="stat-value">${data.latency_monitor.average_latency || 0} ms</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Jitter:</span>
                                <span class="stat-value">${data.latency_monitor.jitter || 0} ms</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Packet Loss:</span>
                                <span class="stat-value">${data.latency_monitor.packet_loss || 0}%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Stability:</span>
                                <span class="stat-value ${(data.latency_monitor.stability || '').toLowerCase()}">${data.latency_monitor.stability || 'Unknown'}</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="latencyChart"></canvas>
                        </div>
                    </div>
                `;
            } else if (data.latency_monitor) {
                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-heartbeat"></i> Latency Monitoring</h3>
                        <div class="chart-placeholder">
                            <p>No latency data available for chart display</p>
                        </div>
                    </div>
                `;
            }

            // Bandwidth Quality
            if (data.bandwidth_quality) {
                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-tachometer-alt"></i> Bandwidth Quality Test</h3>
                        <div class="speed-metrics">
                            <div class="metric-card">
                                <div class="metric-value">${data.bandwidth_quality.average_speed_mbps} Mbps</div>
                                <div class="metric-label">Average Speed</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.bandwidth_quality.quality}</div>
                                <div class="metric-label">Quality Rating</div>
                            </div>
                        </div>
                        <p><strong>Tested Speeds:</strong> ${data.bandwidth_quality.tested_speeds ? data.bandwidth_quality.tested_speeds.join(', ') : 'N/A'} Mbps</p>
                        <p><strong>Recommendation:</strong> ${data.bandwidth_quality.recommendation || 'No recommendation available'}</p>
                    </div>
                `;
            }

            // DNS Performance
            if (data.dns_performance) {
                const performanceClass = data.dns_performance.performance === 'Poor' ? 'danger' :
                                      data.dns_performance.performance === 'Fair' ? 'warning' : 'success';

                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-globe"></i> DNS Performance</h3>
                        <div class="alert alert-${performanceClass}">
                            <h4><i class="fas fa-server"></i> DNS Performance: ${data.dns_performance.performance}</h4>
                            <p>Average Response Time: ${data.dns_performance.average_response_time} ms</p>
                        </div>

                        <h5>Domain Response Times:</h5>
                        <div class="domain-response-times">
                `;

                if (data.dns_performance.response_times) {
                    Object.entries(data.dns_performance.response_times).forEach(([domain, time]) => {
                        const responseClass = typeof time === 'number' ?
                            (time < 50 ? 'good' : time < 100 ? 'fair' : 'poor') : 'error';

                        html += `
                            <div class="domain-response ${responseClass}">
                                <span class="domain">${domain}</span>
                                <span class="response-time">${typeof time === 'number' ? time + ' ms' : time}</span>
                            </div>
                        `;
                    });
                }

                html += `</div></div>`;
            }

            // Bottleneck Analysis
            if (data.bottleneck_analysis) {
                const severityClass = data.bottleneck_analysis.overall_severity === 'High' ? 'danger' :
                                   data.bottleneck_analysis.overall_severity === 'Medium' ? 'warning' : 'success';

                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-exclamation-triangle"></i> Network Bottleneck Analysis</h3>
                        <div class="alert alert-${severityClass}">
                            <h4><i class="fas fa-info-circle"></i> Overall Status: ${data.bottleneck_analysis.overall_severity} Severity</h4>
                            <p>Found ${data.bottleneck_analysis.bottlenecks_found} potential bottleneck(s)</p>
                        </div>
                `;

                if (data.bottleneck_analysis.bottlenecks && data.bottleneck_analysis.bottlenecks.length > 0) {
                    html += '<div class="bottleneck-list">';
                    data.bottleneck_analysis.bottlenecks.forEach(bottleneck => {
                        html += `
                            <div class="bottleneck-item ${bottleneck.severity.toLowerCase()}">
                                <div class="bottleneck-header">
                                    <span class="severity-badge ${bottleneck.severity.toLowerCase()}">${bottleneck.severity}</span>
                                    <strong>${bottleneck.type}</strong>
                                </div>
                                <p>${bottleneck.description}</p>
                                <div class="suggestion">
                                    <i class="fas fa-lightbulb"></i> <strong>Suggestion:</strong> ${bottleneck.suggestion}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> No significant bottlenecks detected. Your connection appears to be in good condition.
                        </div>
                    `;
                }

                html += `</div>`;
            }

            // Throughput Test
            if (data.throughput_test && data.throughput_test.throughput_samples && data.throughput_test.throughput_samples.length > 0) {
                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-chart-line"></i> Throughput Test</h3>
                        <div class="speed-metrics">
                            <div class="metric-card">
                                <div class="metric-value">${data.throughput_test.average_throughput} Mbps</div>
                                <div class="metric-label">Average Throughput</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.throughput_test.stability}</div>
                                <div class="metric-label">Connection Stability</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.throughput_test.min_throughput} Mbps</div>
                                <div class="metric-label">Minimum Throughput</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${data.throughput_test.max_throughput} Mbps</div>
                                <div class="metric-label">Maximum Throughput</div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="throughputChart"></canvas>
                        </div>
                    </div>
                `;
            } else if (data.throughput_test) {
                html += `
                    <div class="result-section">
                        <h3><i class="fas fa-chart-line"></i> Throughput Test</h3>
                        <div class="chart-placeholder">
                            <p>No throughput data available for chart display</p>
                        </div>
                    </div>
                `;
            }

            // Troubleshooting Guide
            if (data.troubleshooting_guide) {
                html += displayTroubleshootingGuideHTML(data.troubleshooting_guide);
            }

            resultsDiv.innerHTML = html;

            // Render charts after the HTML is inserted
            setTimeout(() => {
                if (data.latency_monitor && data.latency_monitor.latencies && data.latency_monitor.latencies.length > 0) {
                    renderLatencyChart(data.latency_monitor);
                }
                if (data.throughput_test && data.throughput_test.throughput_samples && data.throughput_test.throughput_samples.length > 0) {
                    renderThroughputChart(data.throughput_test);
                }
            }, 100);
        }

        function displayTroubleshootingGuide(guide) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = displayTroubleshootingGuideHTML(guide);
        }

        function displayTroubleshootingGuideHTML(guide) {
            return `
                <div class="result-section">
                    <h3><i class="fas fa-tools"></i> Troubleshooting Guide</h3>

                    <div class="troubleshooting-section">
                        <h5><i class="fas fa-exclamation-circle"></i> Detected Issues:</h5>
                        <ul>
                            ${(guide.detected_issues || ['No issues detected']).map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="troubleshooting-section">
                        <h5><i class="fas fa-wrench"></i> Recommended Solutions:</h5>
                        <ul>
                            ${(guide.recommended_solutions || ['No specific solutions needed']).map(solution => `<li>${solution}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="troubleshooting-section">
                        <h5><i class="fas fa-bolt"></i> Quick Fixes:</h5>
                        <ul>
                            ${(guide.quick_fixes || []).map(fix => `<li>${fix}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderLatencyChart(latencyData) {
            const canvas = document.getElementById('latencyChart');
            if (!canvas) {
                console.error('Latency chart canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');
            const latencies = latencyData.latencies.map(l => l.latency).filter(l => l !== null && l !== undefined);
            const sequences = latencyData.latencies
                .filter((l, i) => latencyData.latencies[i].latency !== null && latencyData.latencies[i].latency !== undefined)
                .map(l => l.sequence);

            if (latencies.length === 0) {
                console.warn('No valid latency data for chart');
                return;
            }

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sequences,
                    datasets: [{
                        label: 'Latency (ms)',
                        data: latencies,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Latency Over Time'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Sequence Number'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Latency (ms)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            currentCharts.push(chart);
        }

        function renderThroughputChart(throughputData) {
            const canvas = document.getElementById('throughputChart');
            if (!canvas) {
                console.error('Throughput chart canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');
            const throughputs = throughputData.throughput_samples.map(s => s.throughput_mbps);
            const timestamps = throughputData.throughput_samples.map(s =>
                new Date(s.timestamp * 1000).toLocaleTimeString()
            );

            if (throughputs.length === 0) {
                console.warn('No valid throughput data for chart');
                return;
            }

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Throughput (Mbps)',
                        data: throughputs,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Throughput Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Throughput (Mbps)'
                            }
                        }
                    }
                }
            });

            currentCharts.push(chart);
        }

        function getSpeedGrade(speed) {
            if (speed >= 50) return { download: 'Excellent', upload: 'Excellent' };
            if (speed >= 25) return { download: 'Good', upload: 'Good' };
            if (speed >= 10) return { download: 'Fair', upload: 'Fair' };
            return { download: 'Poor', upload: 'Poor' };
        }

        function getLatencyGrade(latency) {
            if (latency < 20) return 'Excellent';
            if (latency < 50) return 'Good';
            if (latency < 100) return 'Fair';
            return 'Poor';
        }

        function getServiceName(port) {
            const services = {
                80: 'HTTP', 443: 'HTTPS', 22: 'SSH', 53: 'DNS',
                21: 'FTP', 25: 'SMTP', 110: 'POP3', 8080: 'HTTP-Alt',
                8443: 'HTTPS-Alt', 3306: 'MySQL', 5432: 'PostgreSQL'
            };
            return services[port] || 'Service';
        }

        // Auto-run complete analysis on page load
        window.addEventListener('load', () => {
            // Show welcome message instead of auto-running tests
            document.getElementById('testResults').innerHTML = `
                <div class="result-section">
                    <h3><i class="fas fa-network-wired"></i> Welcome to Network Diagnostics Tool</h3>
                    <p>Select a test from the tabs above to analyze your network connection.</p>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <i class="fas fa-bolt"></i>
                            <p><strong>Basic Tests</strong></p>
                            <p>Speed, Ping, Traceroute</p>
                        </div>
                        <div class="summary-card">
                            <i class="fas fa-chart-line"></i>
                            <p><strong>Advanced Diagnostics</strong></p>
                            <p>In-depth analysis</p>
                        </div>
                        <div class="summary-card">
                            <i class="fas fa-tools"></i>
                            <p><strong>Troubleshooting</strong></p>
                            <p>Fix connection issues</p>
                        </div>
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>